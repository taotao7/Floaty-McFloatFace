name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target aarch64-apple-darwin"
            rust_target: aarch64-apple-darwin
          - platform: ubuntu-22.04
            args: ""
            rust_target: ""
          - platform: windows-latest
            args: ""
            rust_target: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libx11-dev libxdo-dev libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: bun install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Floaty McFloatFace ${{ github.ref_name }}"
          releaseBody: "See the assets for download links."
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  update-homebrew:
    needs: build
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_URL="https://github.com/taotao7/Floaty-McFloatFace/releases/download/${GITHUB_REF_NAME}/floaty-mcfloatface_${VERSION}_aarch64.dmg"

          # Download and compute SHA256
          curl -sL "$DMG_URL" -o floaty.dmg
          SHA256=$(shasum -a 256 floaty.dmg | awk '{print $1}')

          # Clone tap repo
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/taotao7/homebrew-tap.git" tap
          mkdir -p tap/Casks

          cat > tap/Casks/floaty-mcfloatface.rb <<CASK
          cask "floaty-mcfloatface" do
            version "${VERSION}"
            sha256 "${SHA256}"
            url "https://github.com/taotao7/Floaty-McFloatFace/releases/download/v#{version}/floaty-mcfloatface_#{version}_aarch64.dmg"
            name "Floaty McFloatFace"
            desc "Camera overlay for streaming and screen recording"
            homepage "https://github.com/taotao7/Floaty-McFloatFace"
            app "floaty-mcfloatface.app"
            zap trash: ["~/Library/Application Support/com.tao.floaty-mcfloatface"]
          end
          CASK

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update floaty-mcfloatface to ${VERSION}" || exit 0
          git push
